define(["app","moment"],function(e,t){e.controller("EventSetupCtrl",["$scope","$http","$route","$routeParams","$location","$timeout","$mdDialog",function(e,n,r,o,s,i,a){function u(t,n,r){return r.length>=e.MAX?(e.showAlert(t,n+" events at it's Max, which is "+e.MAX+"."),!1):!0}function d(){var t=[];if(e.fullday)t.push({stime:"0",etime:"0",abookings:e.abookings});else for(var n=0;n<e.timedEvents.length;n++){var r={stime:h(e.timedEvents[n].stime),etime:h(e.timedEvents[n].etime),abookings:e.timedEvents[n].abookings};t.push(r)}return t}function l(){var t={title:e.title,desc:e.desc,userInfo:m(e),conf:e.conf?!0:!1,fullDay:e.fullday?!0:!1,timedEvents:d(),reserveType:e.reserveType,occurrence:[e.monday?!0:!1,e.tuesday?!0:!1,e.wednesday?!0:!1,e.thursday?!0:!1,e.friday?!0:!1,e.saturday?!0:!1,e.sunday?!0:!1],reserveEvents:e.reservedEvents,blackoutEvents:e.blackoutEvents};return t}function v(e){return"undefined"!=typeof e&&e}function c(){return e.setup.$valid&&("opt2"==e.reserveType&&(v(e.monday)||v(e.tuesday)||v(e.wednesday)||v(e.thursday)||v(e.friday)||v(e.saturday)||v(e.sunday))||e.reservedEvents.length>0)&&(e.fullday||e.timedEvents.length>0&&f())?!0:!1}function f(){for(var t=e.timedEvents,n=0;n<t.length;n++)if(e.invalidTimeComparer(n))return!1;return!0}function m(e){var t,n,r=0;return e.add_ctcNo&&(t=e.opt_ctcNo==g?1:2),e.add_email&&(n=e.opt_email==g?1:2),e.add_addr&&(r=e.opt_addr==g?1:2),E(p(n),p(t),p(r))}function p(e){return"undefined"==typeof e?0:e}function E(e,t,n){var r=0;return r+=3*e,r+=9*t,r+=27*n}function h(e){return t(e).format("HHmm")}var g="[Optional]";e.MAX=50;var y=16,k=new Date,b=new Date;e.blackoutEvents=[],e.reservedEvents=[],e.timedEvents=[],e.flag=!1,e.reserveType="opt1",e.hstep=1,e.mstep=30,e.abookings=1,e.minDate=k,k.setMinutes(0),b.setMinutes(30),e.word=/^([A-Z|a-z|0-9]+\s{0,1}[A-Z|a-z|0-9]*)*$/,e.opt_ctcNo=g,e.opt_email=g,e.opt_addr=g,e.addBlackouts=function(t){var n=e.blackoutdates;if("undefined"!=typeof n){var r=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0);e.blackoutEvents.indexOf(r)<0&&u(t,"Blackout",e.blackoutEvents)&&(e.blackoutEvents.push(r),e.blackoutEvents.sort())}},e.removeBlackouts=function(t){e.blackoutEvents.splice(t,1)},e.addReserve=function(t){var n=e.reserveDates;if("undefined"!=typeof n){var r=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0);e.reservedEvents.indexOf(r)<0&&u(t,"Reserve",e.reservedEvents)&&(e.reservedEvents.push(r),e.reservedEvents.sort())}},e.removeReserve=function(t){e.reservedEvents.splice(t,1)},e.addTimeEvents=function(){if(e.timedEvents.length>y)return alert("Maximum Booking Time allowed."),void 0;var t={stime:k,etime:b,abookings:1};e.timedEvents.push(t)},e.removeTimeEvents=function(t){e.timedEvents.splice(t,1)},e.showAlert=function(e,t){a.show(a.alert().title("Opps, Error Encountered").content(t).ariaLabel("Error").ok("Ok!").targetEvent(e))},e.invalidTimeComparer=function(t){var n=angular.element(document.querySelector("#time"+t));return null==e.timedEvents[t].etime||null==e.timedEvents[t].stime||"0000"==h(e.timedEvents[t].stime.getTime())||e.timedEvents[t].etime.getTime()<=e.timedEvents[t].stime.getTime()?(n.css("border-color","#f00"),!0):(n.css("border-color","#000"),!1)},e.resetForm=function(e){var t=a.confirm().title("Reset Form").content("You'll loose all you input. Are you sure?").ariaLabel("Reset").ok("Reset").cancel("No").targetEvent(e);a.show(t).then(function(){r.reload()},function(){})},e.processForm=function(t){if(e.errors=void 0,e.setup.submitted=!0,!e.flag){if(0==c())return e.flag=!1,e.showAlert(t,"There are errors within your input."),s.href="#/eventsetup",void 0;e.flag=!0,e.formData=l();var r=function(){s.url("eventprogress")},o=function(){e.showAlert(t,"There are errors within your input."),e.flag=!1},i=function(n){e.showAlert(t,"There are errors within your input."),e.errors=n.errors,e.flag=!1};funcHTTP(n,"PUT",calendarURL,e.formData,r,o,i)}}}])});