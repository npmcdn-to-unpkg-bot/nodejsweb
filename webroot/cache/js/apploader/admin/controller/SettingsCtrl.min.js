define(["app","reactjs","reactloader","../directive/ngflow"],function(app,react){app.controller("SettingsCtrl",["$rootScope","$scope","$http","$location","$route","$modal","$mdDialog",function($rootScope,$scope,$http,$location,$route,$modal,$mdDialog){function getReact(){return"undefined"==typeof reactFunc&&(reactFunc=react_UserMgmt($scope,react),reactFunc.load()),reactFunc.getReact()}function createProfileJSON(e){return{cDesc:e.setting.profile.cDesc.$viewValue,cWebsite:e.setting.profile.cWebsite.$viewValue,cCtcNo:e.setting.profile.cCtcNo.$viewValue,cEmail:e.setting.profile.cEmail.$viewValue,ver:e.ver}}function saveReport(e){var o={email:e.setting.report.rEmail.$viewValue};return o}$scope.url_pattern=/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/,$scope.ctcNo_pattern=/^\+?[0-9]{0,13}$/,$rootScope.openWindow=!1,$rootScope.imageUrl=cpImageURL+"?"+(new Date).getTime();var reactFunc=void 0;$scope.successFunc=function(e){$scope.userMgmtList=e,getReact().setState({data:e})},$scope.triggerLoad=function(){getHTTP($http,userMgmtListUrl,$scope.successFunc)},$scope.removeUser=function(userId){var confirm=$mdDialog.confirm().title("Remove user").content("Are you sure to remove the user from his subscription?").ariaLabel("User remove").ok("Yes").cancel("No");$mdDialog.show(confirm).then(function(){var succFunc=function(data){var query=eval("({'maskId':'"+userId+"'})"),listData=$scope.userMgmtList;listData.splice(_.findIndex(listData,query),1),getReact().setState({data:listData})},failFunc=function(e){$scope.showAlert("error",e.errors)},errFunc=function(e){$scope.showAlert("error",e.errors)};funcHTTP($http,"DELETE",userMgmtUrl+"/"+userId,{},succFunc,failFunc,errFunc)},function(){})},$scope.triggerLoad(),$scope.open=function(){var e=$modal.open({templateUrl:"popupdialog.html",controller:"ModalInstanceCtrl",resolve:{ver:function(){return $scope.ver}}});e.result.then(function(){$route.reload()},function(){})},$scope.profileSucc=function(e){$scope.cName=e.cName,$scope.cDesc=e.cDesc,$scope.cWebsite=e.cWebsite,$scope.cCtcNo=e.cCtcNo,$scope.cEmail=e.cEmail,$scope.ver=e.ver},$scope.reportSucc=function(e){"ok"!=e.success&&($scope.rEmail=e.email)},getHTTP($http,subsReportURL,$scope.reportSucc),getHTTP($http,adminProfileUrl,$scope.profileSucc),$scope.showAlert=function(e,o){$mdDialog.show($mdDialog.alert().title("Error").content("string"==typeof o?o:o[0]).ariaLabel("There is input error, please check.").ok("Ok!").targetEvent(e))},$scope.showUpdate=function(e){$mdDialog.show($mdDialog.alert().title("Updated").content("Update Completed").ariaLabel("Update Completed").ok("Ok!").targetEvent(e))},$scope.resetProfileForm=function(){$route.reload()},$scope.processProfileForm=function(e){if($scope.profileErrors=void 0,!$scope.profileFlag&&0!=$scope.setting.profile.$valid){$scope.profileFlag=!0,$scope.formData=createProfileJSON($scope);var o=function(){$scope.profileFlag=!1,$scope.showUpdate(e),$route.reload()},r=function(o){$scope.profileFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.profileErrors=o.errors},t=function(o){$scope.profileFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.profileErrors=o.errors};funcHTTP($http,"POST",adminProfileUrl,$scope.formData,o,r,t)}},$scope.processReportForm=function(e){if($scope.reportErrors=void 0,!$scope.reportFlag&&0!=$scope.setting.report.$valid){$scope.reportFlag=!0,$scope.formData=saveReport($scope);var o=function(){$scope.reportFlag=!1,$scope.showUpdate(e)},r=function(o){$scope.reportFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.reportErrors=o.errors},t=function(o){$scope.reportFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.reportErrors=o.errors};funcHTTP($http,"POST",subsReportURL,$scope.formData,o,r,t)}},$scope.processUserMgmtForm=function(e){if($scope.userMgmtErrors=void 0,!$scope.userMgmtFlag&&0!=$scope.setting.usermgmt.$valid&&"undefined"!=typeof $scope.setting.usermgmt.usercode.$viewValue&&""!==$scope.setting.usermgmt.usercode.$viewValue){$scope.userMgmtFlag=!0;var o=function(){$scope.userMgmtFlag=!1,$scope.triggerLoad(),$scope.showUpdate(e)},r=function(o){$scope.userMgmtFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.userMgmtErrors=o.errors},t=function(o){$scope.userMgmtFlag=!1,$scope.showAlert(e,"There are errors to the update."),$scope.userMgmtErrors=o.errors};funcHTTP($http,"PUT",userMgmtUrl+"/"+$scope.setting.usermgmt.usercode.$viewValue,{},o,r,t)}}}]).controller("ModalInstanceCtrl",["$rootScope","$scope","$http","$modalInstance","ver",function(e,o,r,t,c){o.ver=c,o.flag_upload=!1,o.remove=function(e){e.cancel(),o.flag_upload=!1},o.uploader=function(e){var r=e.files[0].name;o.ext=r.substring(r.lastIndexOf("."),r.length),o.flag_upload=!0},o.register=function(){o.flag=!0,o.formData={ver:o.ver,ext:o.ext};var c=function(){o.flag=!1,e.imageUrl=cpImageURL+"?"+(new Date).getTime(),t.close()},s=function(e){o.flag=!1,o.uploadErrors=e.errors},a=function(e){o.flag=!1,o.uploadErrors=e.errors};funcHTTP(r,"POST",subUploadImgURL,o.formData,c,s,a)},o.close=function(){t.dismiss()}}])});