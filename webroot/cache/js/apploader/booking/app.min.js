"use strict";define(["angularAMD","jquery","lodash","moment","weather","calendar_tut","global_var","cookiereader","auth_common","jquery-ui","angular-sanitize","ui-bootstrap-custom","ui-bootstrap-custom-tpls","ui-calendar"],function(angularAMD,$,_,moment,skycon,tut){function obtainDay(e){return moment(e).format("DD")}var app=angular.module("ngreq-app",["ui.calendar","ui.bootstrap","ngSanitize"]);return app.config(["$httpProvider",function(e){e.defaults.withCredentials=!0,e.defaults.useXDomain=!0}]).controller("calendarCtrl",["$scope","$http","$modal","$compile","$location",function(e,t,n,o,s){tut.tutorialInit(e,s);var r=function(n){e.fstName=n.firstName,e.lstName=n.lastName,e.email=n.email,e.ctcNo=n.ctcNo,e.addr=n.addr,e.pstCd=n.pstCd,e.state=n.state,t.get("/cache/json/mlystate.json").success(function(t){e.states=t}),skycon.sendMessage(e.state,(new Date).getTime())};e.allowSetup=cookieAccess("Cal_Ctrl"),getHTTP(t,userProfileURL,r);{var a=new Date;a.getDate(),a.getMonth(),a.getFullYear()}e.flag=!1,e.currEvents=[],e.events={url:calendarURL,className:"btn unreserved",xhrFields:{withCredentials:!0}},e.reservedEvents={url:reservationURL,className:"btn reserved",xhrFields:{withCredentials:!0}},e.pendingEvents={url:pendingURL,className:"btn pending",xhrFields:{withCredentials:!0}},e.alertOnEventClick=function(t){var n=$(this).hasClass("reserved")?1:$(this).hasClass("pending")?2:0;skycon.sendMessage(e.state,new Date(t.start).getTime()),e.currEvents=[];var o={title:t.title,start:new Date(t.start),end:new Date(t.end),allDay:t.allDay,desc:t.desc,booked:n,userInfo:"undefined"==typeof t.userInfo?0:t.userInfo,conf:t.conf,id:t._id};e.currEvents.push(o)},e.alertEventOnClick=function(t){skycon.sendMessage(e.state,t)},e.addEvent=function(){},e.changeView=function(t){e.myCalendar.fullCalendar("changeView",t)},e.eventRender=function(t,n){n.attr({tooltip:t.title,"tooltip-append-to-body":!0}),o(n)(e)},e.uiConfig={calendar:{height:450,editable:!1,ignoreTimezone:!1,header:{left:"title",center:"",right:"today prev,next"},dayClick:e.alertEventOnClick,eventClick:e.alertOnEventClick,eventRender:e.eventRender}},e.open=function(e,t){"undefined"==typeof t&&(t="");n.open({templateUrl:"popupdialog.html",controller:"ModalInstanceCtrl",resolve:{status:function(){return e},message:function(){return t}}})},e.openVer2=function(t,o,s,r,a,c,i,l,d){"undefined"==typeof t&&(t=0);var u=n.open({templateUrl:"usercontent.html",controller:"ModalUserReqCtrl",backdrop:"static",resolve:{errors:function(){return"undefined"==typeof d?[]:d},id:function(){return o},conf:function(){return s},userInfo:function(){return t},email:function(){return r},ctcNo:function(){return a},addr:function(){return c},pstCd:function(){return i},state:function(){return l},listStates:function(){return e.states}}});u.result.then(function(t){"undefined"!=typeof t&&e.confirmBooking("POST",t)},function(){})},e.ok=function(t,n,o){0==o?e.confirmBooking("POST",{_id:t,conf:n,userInfo:0}):e.openVer2(o,t,n,e.email,e.ctcNo,e.addr,e.pstCd,e.state)},e.cancel=function(t){e.confirmBooking("DELETE",{_id:t})},e.confirmBooking=function(n,o){if(!e.flag){e.flag=!0,e.formData=o;var s=function(){e.flag=!1,e.currEvents=[],e.myCalendar.fullCalendar("refetchEvents"),e.open("ok","DELETE"==n?"Booking Cancelled.":o.conf?"Booked. Your booking is now pending approval from the organizer.":"Booking Confirmed.")},r=function(t){e.flag=!1,e.open("nak",t.errors)},a=function(t){e.flag=!1,"POST"==n&&0!=o.userInfo?e.openVer2(o.userInfo,o._id,o.conf,o.email,o.ctcNo,o.addr,o.pstCd,o.state,t.errors):e.open("nak","undefined"!==t.errors?t.errors:"Internal Server Error, please try again.")};funcHTTP(t,n,reservationURL,e.formData,s,r,a)}},e.tutorialRun?(e.tutEvents=[],e.eventSources=[e.tutEvents]):e.eventSources=[e.events,e.reservedEvents,e.pendingEvents]}]).controller("ModalInstanceCtrl",["$scope","$modalInstance","status","message",function(e,t,n,o){if(e.status="ok"==n?!0:!1,e.status)e.statMsg=o;else{if("string"!=typeof o){var s=o;o="";for(var r=0;r<s.length;r++)o+=s[r],r+1<s.length&&(o+=",")}e.statMsg=""===o?"Booking Not Accepted.":o}e.ok=function(){t.close()}}]).controller("ModalUserReqCtrl",["$scope","$modalInstance","errors","id","conf","userInfo","email","ctcNo","addr","pstCd","state","listStates",function($scope,$modalInstance,errors,id,conf,userInfo,email,ctcNo,addr,pstCd,state,listStates){$scope.checkUserInfo=function(e){var t=$scope.userInfo.toString(3),n=-1;switch(e){case"Email":n=t.length-2;break;case"ContactNo":n=t.length-3;break;case"Address":n=t.length-4}return 0>n?0:parseInt(t.charAt(n),10)};var isActValid=function(e){return 0==$scope.checkUserInfo(e)?!1:!0};$scope.isReq=function(e){return 2==$scope.checkUserInfo(e)?!0:!1},$scope.postalCd=/^[1-9][0-9]{0,4}$/,$scope.number=/^\+?[0-9]{0,13}$/,$scope.userInfo=userInfo,$scope.dtl_email=email,$scope.dtl_ctcNo=ctcNo,$scope.dtl_addr=addr,$scope.dtl_pstCd=pstCd,$scope.states=listStates,$scope.errors=0!=errors.length?errors:void 0;var jsonState=eval("({'id':'"+state+"'})");$scope.dtl_state=$scope.states[_.findIndex($scope.states,jsonState)],$scope.isEmailShow=isActValid("Email"),$scope.isContactNoShow=isActValid("ContactNo"),$scope.isAddressShow=isActValid("Address"),$scope.dtl_ok=function(){if($scope.detail.$valid){var e={_id:id,conf:conf,userInfo:$scope.userInfo};$scope.isEmailShow&&(e.email=$scope.dtl_email),$scope.isContactNoShow&&(e.ctcNo=$scope.dtl_ctcNo),$scope.isAddressShow&&(e.state=$scope.dtl_state.id,e.pstCd=$scope.dtl_pstCd,e.addr=$scope.dtl_addr),$modalInstance.close(e)}},$scope.dtl_cancel=function(){$modalInstance.close()}}]),angularAMD.bootstrap(app)});