angular.module("ui.calendar",[]).constant("uiCalendarConfig",{}).controller("uiCalendarCtrl",["$scope","$timeout",function(n,e){var a=1,r=1,t=n.eventSources,l=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,o=function(n){var a;return n&&(a=function(){var a=arguments,r=this;e(function(){n.apply(r,a)})}),a};this.eventsFingerprint=function(n){return n._id||(n._id=r++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+l(n)||""},this.sourcesFingerprint=function(n){return n.__id||(n.__id=a++)},this.allEvents=function(){for(var n=[],e=0,a=t.length;a>e;e++){var r=t[e];if(angular.isArray(r))n.push(r);else if(angular.isObject(r)&&angular.isArray(r.events)){var l={};for(var o in r)"_uiCalId"!==o&&"events"!==o&&(l[o]=r[o]);for(var u=0;u<r.events.length;u++)angular.extend(r.events[u],l);n.push(r.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(n,e){var a,r=function(){for(var a,r,t=angular.isFunction(n)?n():n,o=[],u=0,i=t.length;i>u;u++)r=t[u],a=e(r),l[a]=r,o.push(a);return o},t=function(n,e){var a,r,t=[],l={};for(a=0,r=e.length;r>a;a++)l[e[a]]=!0;for(a=0,r=n.length;r>a;a++)l[n[a]]||t.push(n[a]);return t},l={},o=function(n,r){var o,u,i,d,c={},f=t(r,n);for(o=0,u=f.length;u>o;o++){var s=f[o];i=l[s],delete l[s];var v=e(i);v===s?a.onRemoved(i):(c[v]=s,a.onChanged(i))}var g=t(n,r);for(o=0,u=g.length;u>o;o++)d=g[o],i=l[d],c[d]||a.onAdded(i)};return a={subscribe:function(n,e){n.$watch(r,function(n,a){e&&e(n,a)===!1||o(n,a)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var a={};return angular.extend(a,e),angular.extend(a,n),angular.forEach(a,function(n,e){"function"==typeof n&&(a[e]=o(a[e]))}),a}}]).directive("uiCalendar",["uiCalendarConfig","$locale",function(n,e){var a=function(n){var e,a;e=[];for(a in n)e[a]=n[a];return e},r=e.DATETIME_FORMATS;return n=angular.extend({monthNames:a(r.MONTH),monthNamesShort:a(r.SHORTMONTH),dayNames:a(r.DAY),dayNamesShort:a(r.SHORTDAY)},n||{}),{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,a,r,t){function l(){var a,l=r.uiCalendar?e.$parent.$eval(r.uiCalendar):{};a=t.getFullCalendarConfig(l,n),c={eventSources:o},angular.extend(c,a);var u={};for(var i in c)"eventSources"!==i&&(u[i]=c[i]);return JSON.stringify(u)}var o=e.eventSources,u=!1,i=t.changeWatcher(o,t.sourcesFingerprint),d=t.changeWatcher(t.allEvents,t.eventsFingerprint),c=null;e.destroy=function(){e.calendar&&e.calendar.fullCalendar&&e.calendar.fullCalendar("destroy"),e.calendar=r.calendar?e.$parent[r.calendar]=$(a).html(""):$(a).html("")},e.init=function(){e.calendar.fullCalendar(c)},i.onAdded=function(n){e.calendar.fullCalendar("addEventSource",n),u=!0},i.onRemoved=function(n){e.calendar.fullCalendar("removeEventSource",n),u=!0},d.onAdded=function(n){e.calendar.fullCalendar("renderEvent",n)},d.onRemoved=function(n){e.calendar.fullCalendar("removeEvents",function(e){return e._id===n._id})},d.onChanged=function(n){n._start=$.fullCalendar.moment(n.start),n._end=$.fullCalendar.moment(n.end),e.calendar.fullCalendar("updateEvent",n)},i.subscribe(e),d.subscribe(e,function(){return u===!0?(u=!1,!1):void 0}),e.$watch(l,function(){e.destroy(),e.init()})}}}]);